name: Weekly Mutation Testing

on:
  schedule:
    # Run every Sunday at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  mutation-test:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true

      - uses: leanprover/lean-action@v1
        with:
          build: true

      - name: Build testdata project
        run: cd testdata && lake build

      - name: Run mutation tests
        id: mutation
        run: |
          START_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          START_EPOCH=$(date +%s)
          echo "start_time=${START_TIME}" >> $GITHUB_OUTPUT

          lake exe leanmutator mutate testdata/TestLib.lean --build --format json 2>&1 | tee /tmp/mutation_output.txt || true

          END_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          END_EPOCH=$(date +%s)
          DURATION=$((END_EPOCH - START_EPOCH))
          echo "end_time=${END_TIME}" >> $GITHUB_OUTPUT
          echo "duration=${DURATION}" >> $GITHUB_OUTPUT

          # Extract JSON stats from output
          grep -o '"total": [0-9]*' /tmp/mutation_output.txt | head -1 | grep -o '[0-9]*' > /tmp/total.txt || echo "0" > /tmp/total.txt
          grep -o '"killed": [0-9]*' /tmp/mutation_output.txt | head -1 | grep -o '[0-9]*' > /tmp/killed.txt || echo "0" > /tmp/killed.txt
          grep -o '"survived": [0-9]*' /tmp/mutation_output.txt | head -1 | grep -o '[0-9]*' > /tmp/survived.txt || echo "0" > /tmp/survived.txt
          grep -o '"timedOut": [0-9]*' /tmp/mutation_output.txt | head -1 | grep -o '[0-9]*' > /tmp/timedout.txt || echo "0" > /tmp/timedout.txt
          grep -o '"errors": [0-9]*' /tmp/mutation_output.txt | head -1 | grep -o '[0-9]*' > /tmp/errors.txt || echo "0" > /tmp/errors.txt
          grep -o '"score": "[^"]*"' /tmp/mutation_output.txt | head -1 | grep -o '[0-9.]*' > /tmp/score.txt || echo "0" > /tmp/score.txt

      - name: Generate status file
        run: |
          TOTAL=$(cat /tmp/total.txt)
          KILLED=$(cat /tmp/killed.txt)
          SURVIVED=$(cat /tmp/survived.txt)
          TIMED_OUT=$(cat /tmp/timedout.txt)
          ERRORS=$(cat /tmp/errors.txt)
          SCORE=$(cat /tmp/score.txt)

          # Format duration
          DURATION=${{ steps.mutation.outputs.duration }}
          if [ "$DURATION" -ge 3600 ]; then
            DURATION_FMT="$((DURATION / 3600))h $((DURATION % 3600 / 60))m $((DURATION % 60))s"
          elif [ "$DURATION" -ge 60 ]; then
            DURATION_FMT="$((DURATION / 60))m $((DURATION % 60))s"
          else
            DURATION_FMT="${DURATION}s"
          fi

          cat > testdata/mutation_status.md << 'HEADER'
          # Mutation Testing Status
          HEADER

          cat >> testdata/mutation_status.md << EOF

          Last updated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ## Summary

          | Metric | Value |
          |--------|-------|
          | Score | **${SCORE}%** |
          | Total Mutations | ${TOTAL} |
          | Killed | ${KILLED} |
          | Survived | ${SURVIVED} |
          | Timed Out | ${TIMED_OUT} |
          | Errors | ${ERRORS} |
          | **Duration** | **${DURATION_FMT}** |

          ## Test Configuration

          - **Target**: \`testdata/TestLib.lean\`
          - **Mode**: Build (full compilation)
          - **Generator**: LeanMutator
          - **Started**: ${{ steps.mutation.outputs.start_time }}
          - **Finished**: ${{ steps.mutation.outputs.end_time }}

          ## Notes

          - Automated weekly run via GitHub Actions
          - Tests use \`#guard\` compile-time assertions
          - Mutations are tested by full compilation (\`--build\` flag)
          EOF

      - name: Commit and push status
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add testdata/
          git diff --staged --quiet || git commit -m "Update mutation testing status [skip ci]"
          git push
